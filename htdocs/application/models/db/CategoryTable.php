<?php

/**
 * CategoryTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class CategoryTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object CategoryTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Category');
    }
    
    /**
     * Used to get main categories.
     * 
     * @return Doctrine_Collection
     */
    public function getMainCategories()
    {
        return $this->createQuery()
                ->addWhere("parent_category_id IS NULL")
                ->orderBy("name ASC")
                ->execute();
    }
    
    /**
     * Used to get list of categories to place in combo box.
     * 
     * @param type $withoutCategoryId
     * @return array id => category
     */
    public function getCategoriesList()
    {
        $categories = $this->getMainCategories();
        
        $categoriesArray = array();
        return $this->_addCategories($categories, $categoriesArray, null, false);
    }
    
    /**
     * Used to get list of categories to place in combo box.
     * 
     * @param type $withoutCategoryId
     * @return array id => prefix . name
     */
    public function getCategoriesListToList($withoutCategoryId = null)
    {
        $categories = $this->getMainCategories();
        
        $categoriesArray = array();
        $categoriesArray[ParamIdEnum::CATEGORY_MAIN_CATEGORY_PARENT_ID] = Helper::getTranslator()->translate('caption-category_main');
        
        $this->_addCategories($categories, $categoriesArray, $withoutCategoryId);
        
        return $categoriesArray;
    }
    
    /**
     * Returns all child categories from parent category of given category and
     * child categories from given category.
     * 
     * @param Category $category
     * @return array With category Ids
     */
    public function getCategoriesToExpand(Category $category)
    {
        return array_merge(
            $this->_getAllChildCategoryIdsFromCategory($category),
            $this->_getAllChildCategoryIdsFromParentCategory($category)
        );
    }
    
    private function _getAllChildCategoryIdsFromParentCategory(Category $category)
    {
        $childCategoryIds = array();
        $childCategories = is_null($category->Category->id) ?
                $this->getMainCategories() :
                $this->findBy('parent_category_id', $category->parent_category_id);
        
        foreach ($childCategories as $childCategory)
            $childCategoryIds[] = $childCategory->id;
        
        return $childCategoryIds;
    }
    
    private function _getAllChildCategoryIdsFromCategory(Category $category)
    {
        $childCategoryIds = array();
        foreach ($category->Categories as $childCategory)
            $childCategoryIds[] = $childCategory->id;
        
        return $childCategoryIds;
    }
    
    /**
     * Used to add categories to categories array.
     * 
     * @param Doctrine_Collection $categories
     * @param array $categoriesArray
     * @param type $withoutCategoryId   Skips category with this ID and it's subcategories
     * @param type $addNameOnly         Adds name only, otherwise whole Doctrine_Recorde
     * @return type
     */
    private function _addCategories(Doctrine_Collection $categories, array &$categoriesArray, $withoutCategoryId, $addNameOnly = true)
    {
        $categoryPrefix = Helper::getTranslator()->translate('caption-category_list_prefix');
        foreach ($categories as $category)
        {
            if ($category->id !== $withoutCategoryId)
            {
                $category->refresh(true);
                $category->name = $categoryPrefix . $category->name;
                $categoriesArray[$category->id] = $addNameOnly ? $category->name : $this->_getCategoryAsArray($category);
                $this->_addSubCategories(
                    $categoriesArray, 
                    $category, 
                    $categoryPrefix . $categoryPrefix, 
                    $withoutCategoryId,
                    $addNameOnly
                );
            }
        }
        
        return $categoriesArray;
    }
    
    private function _getCategoryAsArray(Category $category)
    {
        return array (
            FieldIdEnum::CATEGORY_ID                    =>  $category->id,
            FieldIdEnum::CATEGORY_DESCRIPTION           =>  $category->description,
            FieldIdEnum::CATEGORY_NAME                  =>  $category->name,
            FieldIdEnum::CATEGORY_PARENT_CATEGORY_ID    =>  $category->parent_category_id
        );
    }
    
    /**
     * Used to recurently add subcategories to categories array.
     * 
     * @param array $categoriesArray
     * @param Category $category
     * @param String $subCategoryPrefix
     * @param String $withoutCategoryId     Skips category with this ID and it's subcategories
     * @param Boolean $addNameOnly          Adds name only, otherwise whole Doctrine_Recorde
     */
    private function _addSubCategories(array &$categoriesArray, Category $category, $subCategoryPrefix, $withoutCategoryId, $addNameOnly = true)
    {
        if (count($category->Categories) > 0)
        {
            $categoryPrefix = Helper::getTranslator()->translate('caption-category_list_prefix');
            foreach ($this->_getCatogoriesForParentId($category->id) as $subCategory)
            {
                if ($subCategory->id !== $withoutCategoryId)
                {
                    $subCategory->refresh(true);
                    $subCategory->name = $subCategoryPrefix . $subCategory->name;
                    $categoriesArray[$subCategory->id] = $addNameOnly ? $subCategory->name : $this->_getCategoryAsArray($subCategory);
                    $this->_addSubCategories(
                        $categoriesArray, 
                        $subCategory, 
                        $subCategoryPrefix . $categoryPrefix, 
                        $withoutCategoryId,
                        $addNameOnly
                    );
                }
            }
        }
        
        return $categoriesArray;
    }
    
    /**
     * Returns collection with categories for given parent_category_id soreted by name ascending.
     * 
     * @param String $parentCategoryId
     * @return Doctrine_Collection
     */
    private function _getCatogoriesForParentId($parentCategoryId)
    {
        return $this->createQuery()
                ->addWhere("parent_category_id = ?", $parentCategoryId)
                ->orderBy("name ASC")
                ->execute();
    }
}